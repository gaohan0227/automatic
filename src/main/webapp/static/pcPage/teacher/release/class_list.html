<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../css/index.css">
    <script type="text/javascript" src="../../libs/jquery.min.js"></script>
    <script type="text/javascript" src="../../libs/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../js/page.js"></script>
    <script type="text/javascript" src="../../js/tool.js"></script>
    <script type="text/javascript" src="../../js/pageInit.js"></script>
    <script type="text/javascript" src="../../js/vue.min.js"></script>
   <script type="text/javascript" src="../../js/service/service-tool.js"></script>
   <script type="text/javascript" src="../../js/service/service-verify.js"></script>
    <style>
        .class_list {
            padding: 0 0.8rem;
        }

        .class_list .class_item {
            width: 100%;
            height: 3rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eaeaea;
        }

        .class_list .class_item img {
            width: 0.6rem;
            height: 0.6rem;
        }

        .class_list .class_item .checkImg {
            width: 1rem;
            height: 1rem;
        }

        .class_list .class_item .class_title {
            padding: 0 0.7rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #2F2F2F;
            font-size: 0.8rem;
        }

        .class_list .class_item .change_unit {
            flex: 1;
            text-align: right;
            padding: 0 0.15rem;
            font-size: 0.75rem;
            color: #d5d5d5;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .class_list .class_item .change_unit.active {
            color: #2f2f2f;
        }

        .class_fixed {
            padding: 0.35rem 0.8rem;
            position: fixed;
            bottom: 0rem;
            left: 0;
            width: 100%;
            height: 2.7rem;
            background: #fff;
            box-shadow: 0 0.1rem 0.5rem 0 rgba(0, 0, 0, 0.1);
        }

        .class_fixed .class_btn {
            width: 100%;
            height: 2rem;
            background: #5296FF;
            border-radius: 1rem;
            color: #fff;
            text-align: center;
            font-size: 0.75rem;
            line-height: 2rem;
        }

        .class_fixed .class_btn.gray_bg {
            background: #EAEAEA;
            color: #acacac;
        }
    </style>
</head>

<body>
    <div class="vueApp" v-cloak>
        <div v-if="isLoad">
            <div v-if="listData.length>'0'">
                <div class="class_list">
                    <div class="class_item" v-for="item,index in listData">
                        <img class="checkImg" :src="classId==item.id?'../../image/release/checked.png':'../../image/release/no_check.png'" alt="" tapmode @click="fnClickClass(item.id)">
                        <p class="class_title">{{item.classNames}}</p>
                        <p :class="item.unitId==''?'change_unit':'change_unit active'" tapmode @click="fnChangeUnit(index)" v-text="item.unitId==''?'请选择单元':item.unitName"></p>
                        <img src="../../image/release/go_page_unit.png" alt="">
                    </div>
                </div>
            </div>
            <div class="none_data" v-if="listData.length=='0'">
                <div>
                    <img src="../../image/no_page/no_class.png" alt="">
                </div>
            </div>
        </div>
        <div style="height:2.7rem;width:100%;" class="change_bottom"></div>
        <!-- <div class="class_fixed" tapmode onclick="fnSetClass()">
            <div class="class_btn">确认</div>
        </div> -->
    </div>
</body> 
<script type="text/javascript">
    var vm;
   
 window.onload = function() {
        fnInit();
//      api.addEventListener({
//          name: 'setUnit'
//      }, function(ret, err) {
//          if (ret) {
//              for (var i = 0; i < vm.listData.length; i++) {
//                  if (ret.value.classId == vm.listData[i].id) {
//                      vm.listData[i].unitId = ret.value.unitId;
//                      vm.listData[i].unitName = ret.value.unitName;
//                  }
//              }
//          }
//      });
//      api.addEventListener({
//          name: 'submitBottom'
//      }, function(ret, err) {
//          if (ret) {
//              fnSetClass();
//          }
//      });

        fnInitPage();
    }

    function fnInit() {
        vm = new Vue({
            el: ".vueApp",
            data: {
                classId:  "",
                listData: [],
                pageNo: "1",
                isLoad: false
            },
            methods: {
                fnClickClass: function(cId) {
                    this.classId = cId;
                }
            }
        })
    }

    function fnChangeUnit(index) {
        var param = {
            name: 'change_unit_alert',
            url: './change_unit_alert.html',
            useWKWebView: true,
            bgColor: 'rgba(0,0,0,0)',
            rect: {
                x: 0,
                y: 0,
                w: "auto",
                h: "auto"
            },
            pageParam: {
                classId: vm.listData[index].id,
                unitId: vm.listData[index].unitId,
                unitList: vm.listData[index].unitList,
            }
        }
        fnOpenFrame(param);
    }

    function fnSetClass() {
        if (vm.classId == "") {
            fnToast("请选择班级");
            return;
        };

        for (var i = 0; i < vm.listData.length; i++) {
            if (vm.classId == vm.listData[i].id) {
                var pageD = {
                    classId: vm.listData[i].id,
                    className: vm.listData[i].classNames,
                    unitId: vm.listData[i].unitId,
                    unitName: vm.listData[i].unitName,
                }
            }
        }
        if (pageD && pageD.unitId != "") {
//          api.sendEvent({
//              name: 'setClass',
//              extra: pageD
//          });
            fnDelayCloseWin()
        } else {
            fnToast("请选择班级下对应的单元。");
        }
    }

    function fnInitPage() {
        fnGetList();
//      fnAddHeaderRefreshingEvent(function() { //设置下拉刷新
//          fnGetList('headerRefreshing');
//      });
//      fnAddFooterLoadingEvent(function() { // 设置上拉加载
//          fnGetList('load');
//      });
    }

    function fnGetList(pSign) {
        if (pSign != "load") { //刷新
            if (pSign != "headerRefreshing") {
//              $S.ShowProgress();
            }
            vm.pageNo = 1;
        } else { //加载
//          $S.ShowProgress();
        }
        var postData = {
            "pageNo": vm.pageNo,
            "pageSize": "10"
        }
        POST("apiAppTeacher/findTeacherClassList", postData, function(ret, err) {
            if (ret && ret.status == "200") {
                if (vm.pageNo == '1') {
                    vm.listData = [];
                }
                for (var i = 0; i < ret.data.listData.length; i++) {
//                  if (api.pageParam.unitId && api.pageParam.unitId != ""&&ret.data.listData[i].id==api.pageParam.classId) {
//                      ret.data.listData[i].unitName = api.pageParam.unitName || "";
//                      ret.data.listData[i].unitId = api.pageParam.unitId || "";
//                  } else {
//                      ret.data.listData[i].unitName = "";
//                      ret.data.listData[i].unitId = "";
//                  }
                }
                vm.listData.push.apply(vm.listData, ret.data.listData);
                console.log(JSON.stringify(vm.listData))
                if (!vm.isLoad) {
                    fnOpenBottomFrame();
                }
                vm.pageNo++;
            }
//          $S.CloseProgress();
//          api.refreshHeaderLoadDone();
            vm.isLoad = true;
//          api.setFrameAttr({
//              name: 'mine/change_bottom',
//              hidden: vm.listData.length > 0 ? false : true
//          });

        })
    }
    //修改当前的frame的大小以及打开底部的frame
    function fnOpenBottomFrame() {
//      var bottom_h = $api.offset($api.dom(".change_bottom")).h;
//      var _headerH = api.pageParam.headerH;
//      var _footerH = api.pageParam.footerH;
//      api.setFrameAttr({
//          name: api.frameName,
//          rect: {
//              x: 0,
//              y: _headerH,
//              w: "auto",
//              h: api.winHeight - _headerH - _footerH - bottom_h
//          }
//      });
//      var param = {
//          name: "mine/change_bottom",
//          url: './change_bottom.html',
//          useWKWebView: true,
//          bgColor: 'rgba(0,0,0,0)',
//          rect: {
//              x: 0,
//              y: api.winHeight - _footerH - bottom_h,
//              w: "auto",
//              h: bottom_h
//          },
//          pageParam: {
//              listData: vm.listData,
//              bottomText: "确认"
//          }
//      }
//      fnOpenFrame(param);
//      $api.css($api.dom(".change_bottom"), "height:0;");

    }
</script>

</html>
