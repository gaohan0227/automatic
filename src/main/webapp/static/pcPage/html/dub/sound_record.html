<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<script type="text/javascript" src="../../libs/jquery.min.js"></script>
		<script type="text/javascript" src="../../libs/bootstrap.min.js"></script>
		<script type="text/javascript" src="../../js/page.js"></script>
		<script type="text/javascript" src="../../js/tool.js"></script>
		<script type="text/javascript" src="../../js/pageInit.js"></script>
		<title>配音秀详情</title>
		<style>
			html,
			body {
				width: 100%;
				height: 100%;
				background: #F7F7F7;
			}
			
			.dub_title {
				max-width: 1440px;
				height: auto;
				margin: 0 auto;
				padding: 29px 0;
				font-size: 36px;
				font-weight: 500;
				color: rgba(47, 47, 47, 1);
				line-height: 50px;
			}
			
			.sound_record_top {
				max-width: 1440px;
				height: auto;
				margin: 0 auto;
				padding-top: 0px;
				padding-bottom: 51px;
				display: flex;
				justify-content: flex-start;
				position: relative;
				flex-wrap: wrap;
			}
			
			.sound_record_top .sound_record_video {
				width: 61.2%;
				margin-right: 2%;
				background: #fff;
				padding-bottom: 30px;
			}
			
			.sound_record_top .dub_clause_info {
				width: 36.8%;
				background: #fff;
				position: absolute;
				top: 0px;
				bottom: 51px;
				right: 0;
				padding: 32px 30px;
				display: flex;
				flex-direction: column;
			}
			
			.dub_video {
				width: 100%;
				position: relative;
			}
			
			.dub_video:before {
				content: "";
				padding-top: 47.73%;
				background: url(../../img/no_page/dub_detail.png) no-repeat;
				background-size: cover;
				display: block;
			}
			
			.dub_video .dub_play {
				height: 40px;
				background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%);
				position: absolute;
				bottom: 0;
				left: 0;
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 0 20px;
			}
			
			.dub_video .dub_play .dub_progress {
				display: flex;
				flex: 1;
				height: 40px;
				align-items: center;
				justify-content: center;
			}
			
			.dub_video .dub_play .dub_progress .dub_time {
				font-size: 12px;
				color: #fff;
				padding-right: 12px;
			}
			
			.dub_video .dub_play .dub_progress .dub_progress_bar {
				flex: 1;
				position: relative;
			}
			
			.dub_video #video_data {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				/*object-fit: cover;*/
			}
			
			.rang_width_div {
				position: absolute;
				top: 50%;
				left: 0;
				right: 0;
				height: 2px;
				transform: translateY(-50%);
			}
			
			.rang_width_div .rang_width {
				background: #fff;
				width: 0;
				border-radius: 2px;
				height: 2px;
				position: relative;
				z-index: 9;
				width: 0%;
			}
			
			input[type=range] {
				-webkit-appearance: none;
				width: 100%;
				border-radius: 2px;
				background: rgba(255, 255, 255, 0.4);
				position: absolute;
				top: 50%;
				transform: translateY(-50%);
			}
			
			input[type=range]::-webkit-slider-runnable-track {
				height: 2px;
				border-radius: 2px;
			}
			
			input[type=range]:focus {
				outline: none;
			}
			
			input[type=range]::-webkit-slider-thumb {
				-webkit-appearance: none;
				-webkit-appearance: none;
				height: 10px;
				width: 10px;
				transform: translateY(-40%);
				border-radius: 100%;
				background: #fff;
				position: relative;
				border: none;
				z-index: 99;
			}
			
			.sound_record_btn {
				width: 216px;
				height: 44px;
				margin: 0 auto;
				background: rgba(255, 212, 70, 1);
				box-shadow: 0px 6px 20px -7px rgba(255, 188, 13, 1);
				border-radius: 100px;
				font-size: 22px;
				color: rgba(47, 47, 47, 1);
				line-height: 44px;
				text-align: center;
				margin-top: 36px;
				margin-bottom: 17px;
			}
			
			.sound_record_btn.sound_record_btn_gray {
				background: #D5D5D5;
				box-shadow: 0px 6px 20px -7px #ACACAC;
			}
			
			.dub_clause_list {
				margin-top: 30px;
				margin-bottom: 8px;
				background: #f7f7f7;
				flex: 0 1 auto;
				overflow-y: scroll;
				overflow-x: hidden;
			}
			
			.dub_clause_list::-webkit-scrollbar {
				display: none;
			}
			
			.dub_clause_list .dub_clause_item .dub_clause_text {
				padding: 30px 45px;
				padding-top: 25px;
				color: #ACACAC;
				font-weight: 500;
				font-size: 28px;
				line-height: 50px;
				position: relative;
			}
			
			.dub_clause_list .dub_clause_item .dub_clause_text:before {
				content: "";
				position: absolute;
				top: 46px;
				left: 16px;
				width: 10px;
				height: 10px;
				background: #FFD446;
				border-radius: 100%;
			}
			
			.dub_clause_list .dub_clause_item .dub_clause_text.dub_clause_success {
				position: relative;
			}
			
			.dub_clause_list .dub_clause_item .dub_clause_text.dub_clause_success:after {
				content: "";
				position: absolute;
				top: 6px;
				right: 6px;
				width: 0;
				height: 0;
				border-color: #88DF97 #88DF97 transparent transparent;
				border-width: 11px 11px 11px 11px;
				border-style: solid;
				border-radius: 2px 0;
			}
			
			.dub_clause_info .dub_clause_title {
				height: 22px;
				line-height: 22px;
				font-size: 16px;
				position: relative;
				display: flex;
				color: #2f2f2f;
				align-items: center;
			}
			
			.dub_clause_info .dub_clause_title:before {
				content: "";
				position: absolute;
				top: 4px;
				bottom: 4px;
				background: #F7D76D;
				border-radius: 2px;
				width: 3px;
			}
			
			.dub_clause_info .dub_clause_title span {
				padding: 0 10px;
				font-weight: 500;
			}
			
			.recording_item .dub_button_item {
				background: #fff;
				text-align: center;
				position: relative;
			}
			
			.recording_item .dub_button_item .dub_clause_num {
				font-size: 12px;
				line-height: 17px;
				color: #ACACAC;
				padding-top: 20px;
			}
			
			.recording_item .dub_button_item .dub_clause_num span {
				color: #3376DE;
			}
			
			.recording_item .dub_button_item .dub_clause_content {
				font-size: 32px;
				font-weight: 500;
				color: #2f2f2f;
				line-height: 60px;
				padding-top: 18px;
				padding: 0 60px;
			}
			
			.recording_item .dub_button_item .dub_clause_btn {
				display: flex;
				align-items: center;
				justify-content: center;
				margin-top: 60px;
			}
			
			.recording_item .dub_button_item .dub_clause_btn img {
				margin: 0 5%;
				width: 50px;
				height: 50px;
				border-radius: 100%;
			}
			
			.recording_item .dub_button_item .dub_clause_btn img.dub_btn_record {
				width: 80px;
				height: 80px;
			}
			
			.recording_item .dub_button_item .dub_clause_tips {
				font-size: 12px;
				line-height: 17px;
				padding-top: 21px;
				color: #ACACAC;
			}
			
			.recording_item .dub_button_item .dub_clause_score {
				padding-top: 19px;
				color: #3376DE;
				font-size: 16px;
				font-weight: 500;
				line-height: 22px;
			}
			
			.recording_item .dub_button_item .dub_record_time {
				padding-top: 22px;
				font-size: 15px;
				font-weight: 500;
				color: rgba(51, 118, 222, 1);
				line-height: 21px;
			}
			
			.recording_item .dub_button_item .dub_record_progress {
				background: #88DF97;
				margin-top: 100px;
				width: 0%;
				height: 3px;
				border-radius: 2px;
			}
		</style>
	</head>

	<body>
		<div class="soundRecordVue" v-cloak>
			<div v-if="isLoad">
				<p class="dub_title">{{videoName}}视频名称</p>
				<div class="sound_record_top">
					<div class="sound_record_video">
						<div class="dub_video">
							<video id="video_data" preload="meta" :poster="videoCover" :src="video" x5-playsinline="" playsinline="" webkit-playsinline="" onended="fnVideoEnd()">
								<source :src="video" type="video/mp4" />
								<source :src="video" type="video/ogg" />
								<source :src="video" type="video/webm" />
							</video>
							<audio id="audio_data" preload="meta" :src="audioUrl"></audio>
							<div class="dub_play">
								<div class="dub_progress">
									<p class="dub_time">{{fnSecToMin(currentTime)}}/{{fnSecToMin(duration)}}</p>
									<div class="dub_progress_bar">
										<input id="range" type="range" min="0" max="100" v-model="progress" step="1">
										<div class="rang_width_div">
											<p class="rang_width" id="rang_width" :style="'width:'+progress+'%'"></p>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="recording_item">
							<div class="dub_button_item" V-IF="dubClauseList.length>0">
								<p class="dub_clause_num"><span>{{newIndex+1}}</span>/{{dubClauseList.length}}</p>
								<p class="dub_clause_content">{{dubClauseList[newIndex].contentSentence}}</p>
								<div class="dub_clause_btn">
									<img v-if="!isRecord" src="../../img/index/dub_btn_play.png" alt="" @click="fnPlayVideoPart(this,newIndex,'0')">
									<img class="dub_btn_record" :src="isRecord?'../../img/index/dub_btn_record_gray.png':'../../img/index/dub_btn_record.png'" alt="" @click="isRecord?'':fnRecord(this,newIndex)">
									<img v-if="!isRecord" :src="dubClauseList[newIndex].dubAudioUrl!=''?'../../img/index/dub_btn_listen.png':'../../img/index/dub_btn_listen_gray.png'" alt="" @click="fnPlayVideoPart(this,newIndex,'1')">
								</div>
								<p v-if="!isRecord" class="dub_clause_tips">点击开始录音</p>
								<p v-if="!isRecord&&dubClauseList[newIndex].scoreNum!=''" class="dub_clause_score">
									{{dubClauseList[newIndex].scoreNum}}分</p>
								<p v-if="isRecord" class="dub_record_time">{{dubClauseList[newIndex].dubPlayTime}}s</p>
								<p v-if="isRecord" class="dub_record_progress" :style="'width:'+dubClauseList[newIndex].recordWidth+';'"></p>
							</div>
						</div>
						<div v-if="!isRecord" :class="isFinish?'sound_record_btn':'sound_record_btn sound_record_btn_gray'" @click="isFinish?fnOpenDubSuccess():fnOpenSuccess()">预览作品</div>
						<!-- <div class="sound_record_fixed" > -->
						<!-- </div> -->
					</div>
					<div class="dub_clause_info">
						<div class="dub_clause_title">
							<span>配音列表</span>
						</div>
						<div class="dub_clause_list">
							<div class="dub_clause_item" v-for="item,index in dubClauseList" @click="isRecord?'':fnItemClickOpen(index)">
								<div :class="item.scoreNum!=''?'dub_clause_text dub_clause_success':'dub_clause_text'" :style="newIndex==index?'background:#fff':'background:#f7f7f7'">
									{{item.contentSentence}}</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../js/vue.min.js"></script>
	<script type="text/javascript" src="../../js/service/service-tool.js"></script>
	<script type="text/javascript" src="../../js/service/service-verify.js"></script>
	<script type="text/javascript">
		var vm;
		var _video;
		var _audio;
		window.onload = function() {
			fnInit();
			// fnInitAliYunOss();
			_video = document.getElementById("video_data");
			_audio = document.getElementById("audio_data");
		}

		function fnInit() {
			vm = new Vue({
				el: ".soundRecordVue",
				data: {
					newIndex: 0,
					dubType: "dub",
					progress: '0',
					currentTime: 0,
					duration: 0,
					moduleId: "",
					bookId: "",
					video: "",
					videoUrl: "",
					videoUrlSilent: "",
					videoCover: "",
					videoName: "",
					audioUrl: "",
					isRecord: false,
					dubClauseList: [],
					isLoad: false,
					isFinish: false,
				},
				mounted: function() {
					 this.fnInitInfo();
				},
				methods: {
					fnInitInfo: function() {
						//$S.ShowProgress();
						var postData = {
							"moduleDubId": "132b7ea296bf44ec8228cfea7ca72c8a",
						}

						var callback = function(data) {
							alert(JSON.stringify(data))
							vm.videoUrl = data.videoUrl;
							vm.videoUrlSilent = data.videoUrlSilent;
							vm.videoCover = data.videoCover;
							vm.videoName = data.videoName;
							vm.video = vm.videoUrl;
							for(var i = 0; i < data.vtdList.length; i++) {
								data.vtdList[i].startTime = fnSetTimeStamp(data.vtdList[i].startTime);
								data.vtdList[i].endTime = fnSetTimeStamp(data.vtdList[i].endTime);
								data.vtdList[i].isClickOpen = false;
								data.vtdList[i].scoreNum = "";
								data.vtdList[i].recordWidth = '0%';
								data.vtdList[i].dubAudioUrl = "";
								data.vtdList[i].dubPlayTime = (data.vtdList[i].endTime - data.vtdList[i].startTime).toFixed(2);
							}
							vm.dubClauseList = data.vtdList;
							vm.isLoad = true;
							// //$S.CloseProgress();
							vm.$nextTick(function() {
								fnEvevtVideo();
								if(vm.dubClauseList.length > 0) {
									fnItemClickOpen(0, '0');
								};
							})
						};
						POST('AppModule/findDubbingSentenceList', postData, callback);

					}
				}
			})
		}

		function fnBack() {
			fnDelayCloseWin()
		}

		var _dubSuccess = true;
		// function fnOpenDubSuccess() {
		//     if (!_dubSuccess) {
		//         return;
		//     }
		//     _dubSuccess = false;
		//     //$S.ShowProgress();
		//     var postData = {
		//         "moduleDubExtendId": vm.moduleId,
		//         "vtdList": vm.dubClauseList,
		//         "timeNum": (vm.duration / 60).toFixed(2) * 1
		//     }
		//     $S.POST("AppModule/saveDubontent", postData, function (ret, err) {
		//         if (ret && ret.status == "200") {
		//             var pageData = {
		//                 score: ret.data.score + "",
		//                 videoUrl: ret.data.videoUrl,
		//                 videoCover: vm.videoCover,
		//                 studentDubId: ret.data.studentDubId,
		//                 dubType: vm.dubType,
		//                 bookId: vm.bookId || ""
		//             }
		//             fnOpenPublicWin("", "index/dub_success", pageData)
		//         } else {
		//             _dubSuccess = true;
		//         }
		//         //$S.CloseProgress();
		//     })
		// }
		//测试用（同一个视频不用每次都配音）
		function fnOpenSuccess() {
			// var pageData = {
			//     "score": 90,
			//     "studentDubId": "380cf502cadb465b9d4c3648023f8144",
			//     "videoUrl": "http://jylf.oss-cn-beijing.aliyuncs.com/jylf/1d627eb6a1b541f2adeedbcc33a58df6.mp4",
			//     "videoCover": vm.videoCover,
			//     "dubType":vm.dubType,
			//     "bookId":vm.bookId||""
			// }
			// fnOpenPublicWin("", "index/dub_success", pageData)
		}

		function fnItemClickOpen(index, type) {
			vm.newIndex = index;
			for(var i = 0; i < vm.dubClauseList.length; i++) {
				vm.dubClauseList[i].isClickOpen = false;
			}
			vm.dubClauseList[index].isClickOpen = true;
			_video = document.getElementById("video_data");
			_audio = document.getElementById("audio_data");
			_video.muted = false;
			vm.audioUrl = vm.dubClauseList[index].dubAudioUrl;
			fnChangeVideoPlay(vm.dubClauseList[index].startTime, vm.dubClauseList[index].endTime);
		}

		function fnPlayVideoPart(el, index, type) {
			if(el && el.stopPropagation) {
				el.stopPropagation();
			} else {
				window.event.cancelBubble = true;
			};
			_video = document.getElementById("video_data");
			_audio = document.getElementById("audio_data");
			if(type == '1') { //播放无声视频
				if(vm.dubClauseList[index].dubAudioUrl == '') {
					return;
				}
				_video.muted = true;
			} else {
				_video.muted = false;
			}
			fnChangeVideoPlay(vm.dubClauseList[index].startTime, vm.dubClauseList[index].endTime)
		}

		function fnRecord(el, index) {
			fnVideoPlay('0');
			if(el && el.stopPropagation) {
				el.stopPropagation();
			} else {
				window.event.cancelBubble = true;
			};

			vm.isRecord = true;
			var recordTime = 0;
			var _recordTime = setInterval(function() {
				recordTime = ((recordTime * 1000 + 10) / 1000).toFixed(2);
				if(recordTime * 1 >= vm.dubClauseList[index].dubPlayTime * 1) {
					clearInterval(_recordTime);

					vm.dubClauseList[index].recordWidth = '100%';
					vm.isRecord = false;
					vm.dubClauseList[index].scoreNum = "90";
					vm.dubClauseList[index].dubAudioUrl = "声音";
					vm.audioUrl = vm.dubClauseList[index].dubAudioUrl;
					console.log(vm.audioUrl)
					var _isFinish = true;
					for(var i = 0; i < vm.dubClauseList.length; i++) {
						if(vm.dubClauseList[i].dubAudioUrl == "") {
							_isFinish = false;
						}
					}
					vm.isFinish = _isFinish;
					vm.$nextTick(function() {
						//$S.CloseProgress();
					})
				} else {
					vm.dubClauseList[index].recordWidth = ((recordTime / vm.dubClauseList[index].dubPlayTime).toFixed(3)) * 100 + "%";
				}
			}, 10)
		}
		var _stopVideo;

		function fnChangeVideoPlay(startTime, endTime) {
			//用于修改时间
			_video = document.getElementById("video_data");
			_audio = document.getElementById("audio_data");
			clearTimeout(_stopVideo);
			fnVideoPlay(1);
			_video.currentTime = startTime;
			if(_audio.played) {
				_audio.currentTime = 0;
			}
			vm.currentTime = startTime;
			vm.duration = _video.duration && _video.duration > 0 ? _video.duration : 0;
			var _stopTime = (endTime - startTime) * 1000;
			_stopVideo = setTimeout(function() {
				fnVideoPlay(0)
			}, _stopTime);
		}

		function fnVideoPlay(key) {
			_video = document.getElementById("video_data");
			_audio = document.getElementById("audio_data");
			if(key == '1') { //播放
				_video.play();
				if(_video.muted && vm.audioUrl != '') {
					console.log(vm.audioUrl)
					_audio.play();
				} else if(_audio.played) {
					_audio.pause();
				}
				vm.duration = _video.duration && _video.duration > 0 ? _video.duration : 0;
				fnEvevtVideo();
			} else { //暂停
				_video.pause();
				if(_audio.played) {
					_audio.pause();
				}
			}
		}

		function fnEvevtVideo() {
			_video = document.getElementById("video_data");
			_video.addEventListener("timeupdate", function() {
				vm.progress = _video.duration && _video.duration > 0 ? (_video.currentTime / _video.duration) * 100 : '0'; //已播放百分比
				vm.currentTime = _video.currentTime;
				vm.duration = _video.duration && _video.duration > 0 ? _video.duration : 0;
			})
		}
		//视频播放完成
		function fnVideoEnd() {
			// fnLock();
		}

		function fnSecToMin(pSec) { //秒数变分钟数
			var min = Math.floor(pSec / 60),
				second = Math.floor(pSec % 60),
				hour, newMin, time;

			if(min > 60) {
				hour = Math.floor(min / 60);
				newMin = min % 60;
			}

			if(second < 10) {
				second = '0' + second;
			}
			if(min < 10) {
				min = '0' + min;
			}
			return time = hour ? (hour + ':' + newMin + ':' + second) : (min + ':' + second);
		}

		function fnSetTimeStamp(val) {
			var timeArr = val.split(":");
			if(timeArr.length == '1') {
				return timeArr[0] * 1;
			} else if(timeArr.length == '2') {
				return timeArr[1] * 1 + timeArr[0] * 1 * 60;
			} else if(timeArr.length == '3') {
				return timeArr[2] * 1 + timeArr[1] * 1 * 60 + timeArr[2] * 1 * 60;
			}
			return 0
		}
	</script>

</html>